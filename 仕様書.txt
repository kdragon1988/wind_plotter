以下、要件を満たす 「Matrice 4E 推定風（1Hz）ミッション計測・共有システム」仕様書（ドラフト） です。
（RC Plus 2 側アプリ＝計測端末、GCP上＝受信/保存/集計/管理ページ）

⸻

1. 目的・概要

1.1 目的
	•	Matrice 4E 運用時に、操縦UIに表示される 推定風速・風向 を 1秒毎に取得し、座標・高度と合わせてログ化する。
	•	計測ミッション単位でデータを保存・集計し、管理ページから即時共有・閲覧できるようにする。

1.2 対象範囲
	•	コントローラー（DJI RC Plus 2 / Android）にインストールする計測アプリ
	•	受信サーバー（GCP）
	•	管理Webページ（ミッション管理/可視化/集計/共有）

1.3 想定データ（1Hz）
	•	timestamp
	•	lat / lon
	•	altitude（運用で統一：相対高度 or MSL）
	•	wind_speed（推定風速）
	•	wind_direction（推定風向）
	•	任意：品質フラグ（wind warning / GNSS品質 / 飛行状態 等）

⸻

2. 用語定義
	•	ミッション：計測の論理単位。操縦側で「ミッション名・担当者」を入力し、開始/停止して記録する。
	•	サンプル：1秒毎に記録される1行（1レコード）の時系列データ。
	•	管理ページ：GCP上のWeb UI。ミッション一覧、結果保存、集計、共有リンク等を提供。

⸻

3. システム構成

3.1 全体構成
	•	計測アプリ（RC Plus 2）
	•	DJI Mobile SDK（MSDK）で推定風/位置/高度を取得
	•	ローカル永続化（SQLite）
	•	バッチ送信（HTTPS）
	•	GCP（受信・保存・集計）
	•	API（受信/参照/集計/共有）
	•	DB（ミッション・サンプルの保存）
	•	リアルタイム配信（任意：SSE/WS）
	•	管理ページ（Web）
	•	ミッション一覧・詳細
	•	地図・チャート
	•	期間/高度帯などの集計
	•	共有リンク（閲覧専用）

3.2 GCP採用サービス（推奨）
	•	Cloud Run（API / Webホスティング）
	•	Cloud SQL for PostgreSQL（時系列保存）
	•	Cloud Storage（エクスポートCSV/PDFの保存）
	•	Cloud CDN + HTTPS Load Balancer（任意：配信最適化）
	•	Secret Manager（APIキー/JWT署名鍵）
	•	Cloud Logging/Monitoring（監視）

⸻

4. 機能要件

4.1 計測アプリ（RC Plus 2）

4.1.1 ミッション作成・保存
	•	入力項目（必須）
	•	ミッション名
	•	担当者名
	•	任意
	•	メモ（目的、場所、注意事項）
	•	機体識別（自動取得できるなら機体SN等）
	•	挙動
	•	「ミッション保存」押下でローカルにミッション下書きを作成
	•	「計測開始」押下でサーバーへミッション開始を通知し、mission_id を受領

4.1.2 計測開始/停止
	•	計測開始
	•	1Hzでサンプル生成開始
	•	画面上に状態表示（記録中、送信状態、未送件数、最新風速/風向）
	•	計測停止
	•	ローカルで記録停止
	•	未送信データがあれば送信継続（バックグラウンド制約がある前提で、原則はアプリ前面維持）

4.1.3 取得項目（SDK）
	•	1秒毎に確定保存する値（最低限）
	•	timestamp
	•	lat, lon
	•	alt_m
	•	wind_speed_ms
	•	wind_dir_deg
	•	任意（推奨：品質）
	•	wind_warning_level
	•	gps_signal_level / satellite_count 等（取得可能なら）
	•	flight_mode / is_flying

注：WindSpeedの単位がdm/sの場合はアプリ側でm/sへ正規化して保存。

4.1.4 ローカル保存（オフライン耐性）
	•	SQLiteに必ず保存（通信断に備える）
	•	各サンプルに seq（連番）を付与
	•	送信成功（ACK）したサンプルは “送信済みフラグ” を更新

4.1.5 サーバー送信
	•	送信方式：HTTPS
	•	バッチ送信（推奨）
	•	例：10秒ごと、または50件ごとにまとめて送信
	•	再送制御
	•	ACK未受領はリトライ（指数バックオフ）
	•	重複送信はサーバー側で排除（device_id + seq などで一意）

4.1.6 共有の即時性
	•	“計測中のミッション”は管理ページで準リアルタイム更新
	•	MVP：管理ページは5〜10秒間隔ポーリング
	•	強化：SSE/WSでPush

⸻

4.2 サーバー（GCP API）

4.2.1 ミッション管理
	•	ミッション開始
	•	入力：ミッション名、担当者、端末/機体情報（可能なら）
	•	出力：mission_id
	•	ミッション終了
	•	入力：mission_id、終了時刻
	•	出力：成功/失敗
	•	ミッション一覧/検索
	•	条件：日付範囲、担当者、キーワード、状態（進行中/完了）
	•	ミッション削除/アーカイブ（権限者のみ）

4.2.2 テレメトリ受信
	•	バッチ受信エンドポイント
	•	バリデーション
	•	時刻の異常（極端に未来/過去）
	•	座標範囲
	•	風速のレンジ（例：0〜50m/sなど）
	•	正規化
	•	wind_speedの単位統一（m/s）
	•	風向の範囲統一（0〜359）

4.2.3 集計・可視化データ生成
	•	集計対象：ミッション単位
	•	提供する集計（MVP）
	•	期間内：平均風速、最大風速、最小風速
	•	分位：P50 / P90（任意）
	•	高度帯別平均（ビン幅：例 10m/20m/30m 可変）
	•	欠損率（1Hzの想定に対する欠落比）
	•	風向集計（推奨）
	•	ベクトル平均による平均風向
	•	風配図（簡易：N/E/S/Wの割合でも可）

4.2.4 エクスポート
	•	CSV出力（必須）
	•	rawサンプル
	•	集計結果サマリ
	•	PDF出力（任意：Phase2）
	•	生成物はCloud Storageへ保存し、管理ページからダウンロード

4.2.5 共有リンク
	•	ミッション単位で “閲覧専用リンク” を発行
	•	期限付きトークン（例：7日/30日）
	•	閲覧専用は編集不可（削除・担当者変更など不可）

⸻

4.3 管理ページ（Web UI）

4.3.1 ミッション一覧
	•	表示：ミッション名、担当者、開始/終了、状態、サンプル数、平均風速、最大風速
	•	操作：検索・フィルタ・ソート
	•	共有：ミッション毎に共有リンク生成/コピー

4.3.2 ミッション詳細
	•	基本情報：ミッション名、担当者、メモ、機体/端末、開始/終了、欠損率
	•	地図表示：軌跡（lat/lon）
	•	チャート：
	•	風速時系列
	•	高度時系列
	•	高度帯別風速（バー/ライン）
	•	集計パネル：
	•	平均/最大/分位
	•	風向サマリ

4.3.3 リアルタイム表示（進行中ミッション）
	•	最新サンプル時刻、遅延（端末→サーバー）
	•	“受信中”インジケータ
	•	5秒〜10秒程度で更新（MVP）

⸻

5. API仕様（案）

5.1 認証
	•	端末（RC Plus 2）：device_token（JWT or API Key）
	•	管理ユーザー：ログイン（メール/パスワード or Google OAuth）
	•	共有リンク：閲覧専用JWT（期限付き）

5.2 エンドポイント（例）
	•	POST /v1/missions/start
	•	POST /v1/missions/{mission_id}/end
	•	GET  /v1/missions?from=&to=&q=&assignee=&status=
	•	GET  /v1/missions/{mission_id}
	•	POST /v1/telemetry/wind/batch
	•	GET  /v1/missions/{mission_id}/summary?bin_alt=20
	•	POST /v1/missions/{mission_id}/share-link
	•	GET  /v1/missions/{mission_id}/export/csv

5.3 受信ペイロード（例）

{
  "mission_id": "uuid",
  "device_id": "string",
  "samples": [
    {
      "ts": "2026-02-04T11:22:33.000Z",
      "seq": 12345,
      "lat": 35.123456,
      "lon": 139.123456,
      "alt_m": 48.2,
      "wind_speed_ms": 6.3,
      "wind_dir_deg": 275,
      "quality": {
        "wind_warning": 0,
        "gps_level": 4
      }
    }
  ]
}


⸻

6. データベース設計（案）

6.1 missions
	•	id (UUID, PK)
	•	name (text)
	•	assignee (text)
	•	note (text, nullable)
	•	device_id (text)
	•	aircraft_id (text, nullable)
	•	started_at (timestamptz)
	•	ended_at (timestamptz, nullable)
	•	status (enum: running, completed, archived)
	•	created_at / updated_at

6.2 telemetry_wind
	•	mission_id (UUID, index)
	•	ts (timestamptz, index)
	•	seq (bigint)
	•	lat, lon (double)
	•	alt_m (double)
	•	wind_speed_ms (double)
	•	wind_dir_deg (int)
	•	wind_warning (int, nullable)
	•	gps_level (int, nullable)
	•	UNIQUE(device_id, seq) もしくは UNIQUE(mission_id, ts, seq)

⸻

7. 非機能要件

7.1 性能
	•	1端末あたり 1Hz（60件/分）
	•	同時端末：MVPでは 1〜5台を想定（拡張可能な設計）
	•	管理画面閲覧：同時 5〜30人程度（CDN/キャッシュで拡張）

7.2 可用性・耐障害
	•	端末はオフラインでも計測継続（SQLite）
	•	送信は再送で追いつく設計
	•	サーバーはCloud Runで水平スケール

7.3 セキュリティ
	•	HTTPS必須
	•	端末トークンの失効・再発行
	•	共有リンクは期限・閲覧専用
	•	ロール（管理者/閲覧/端末）で権限制御

7.4 監視
	•	受信レート、欠損率、遅延、APIエラー率
	•	ミッション毎のサンプル数の異常検知（急減など）

⸻

8. 画面仕様（要点）

8.1 計測アプリ
	•	ミッション作成画面
	•	ミッション名（必須）
	•	担当者（必須）
	•	メモ（任意）
	•	[保存] [計測開始]
	•	計測中画面
	•	状態（記録/停止）
	•	最新：風速・風向・高度
	•	送信状態（未送件数、最終送信時刻）
	•	[停止] [ミッション終了]

8.2 管理ページ
	•	ミッション一覧（検索/フィルタ）
	•	ミッション詳細（地図/チャート/集計/エクスポート/共有）
	•	共有閲覧ページ（ログイン不要、閲覧専用）

⸻

9. 開発フェーズ（提案）

Phase 1（MVP：最短で運用開始）
	•	RC Plus 2：ミッション作成→1Hz保存→バッチ送信
	•	API：ミッション管理、受信、一覧、詳細、基本集計（平均/最大/欠損）
	•	管理：一覧・詳細、簡易チャート、共有リンク（閲覧専用）

Phase 2（強化）
	•	SSE/WSでリアルタイム強化
	•	分位・風配図・高度帯集計の高度化
	•	PDFレポート生成
	•	ユーザー/ロール管理の充実

⸻

10. 前提・制約
	•	RC Plus 2 でのアプリ運用は、端末側の制約により 計測中はアプリ前面維持を基本とする（バックグラウンド受信制約の影響を回避）。
	•	風速・風向は 機体推定値であり、外部センサー実測ではない（データの性質として明記）。

⸻